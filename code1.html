<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login dan Langganan</title>
  <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-analytics.js"></script>
</head>
<body>

  <h1>Login dan Sistem Langganan</h1>

  <!-- Tombol Login Google -->
  <button id="login-btn">Login dengan Google</button>

  <!-- Pesan jika login gagal -->
  <p id="error-message" style="color:red; display:none;">Login gagal. Coba lagi.</p>

  <script>
    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDAjJ-_jTNh7HucY66o1A6PZh-ohrpETVY",
      authDomain: "temter-df972.firebaseapp.com",
      projectId: "temter-df972",
      storageBucket: "temter-df972.firebasestorage.app",
      messagingSenderId: "224267552779",
      appId: "1:224267552779:web:99d8e441a9b019950f1f0e",
      measurementId: "G-CNYXFR6RKF"
    };

    // Inisialisasi Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();
    const analytics = firebase.analytics(app);

    // Login menggunakan Google
    const loginBtn = document.getElementById("login-btn");
    const errorMessage = document.getElementById("error-message");

    loginBtn.addEventListener('click', function() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          // Mengambil data langganan user dari Firestore
          const userDocRef = firestore.collection('users').doc(user.email);

          userDocRef.get().then((doc) => {
            if (doc.exists) {
              const modulaActive = doc.data().modula_active;
              const modulaExpiry = doc.data().modula_expiry.seconds * 1000; // Timestamp to milliseconds

              const currentDate = new Date().getTime();
              
              if (modulaActive && currentDate < modulaExpiry) {
                // Arahkan ke halaman testdesign5.html jika langganan aktif
                window.location.href = 'testdesign5.html';
              } else {
                // Tampilkan pesan jika langganan sudah kedaluwarsa
                alert('Langganan Anda sudah kedaluwarsa.');
              }
            } else {
              console.log("User data tidak ditemukan.");
              errorMessage.style.display = "block"; // Tampilkan pesan error
            }
          }).catch((error) => {
            console.error("Error fetching user data: ", error);
          });

        }).catch((error) => {
          console.error("Login failed: ", error);
          errorMessage.style.display = "block"; // Tampilkan pesan error
        });
    });
  </script>
</body>
</html>
